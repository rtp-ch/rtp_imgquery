<!DOCTYPE html>
<html>
  <head>
    <title>rtp_imgQuery Tests</title>
    <link rel="stylesheet" href="qunit/qunit.css">
    <script type="text/javascript">
      var imgQry = {};
      imgQry.images = {};
      imgQry.ratios = {};
      imgQry.breakpoints = {};
      
    </script>
  </head>
  <body>
    <div id="qunit"></div>
    <div id="qunit-fixture"></div>
    <script src="qunit/qunit.js" type="text/javascript"></script>
    <script type="text/javascript">
      // Deliberatly without var so that breakpointsIn , imagesIn and ratiosIn are global properties
      // which can be deleted.
      imagesIn = {
          "1":    {
              "300" : '<img src="images/pixel_ratio_1/400.gif" width="400" height="450">',
              "600" : '<img src="images/pixel_ratio_1/300.gif" width="300" height="300">',
              "800" : '<img src="images/pixel_ratio_1/750.gif" width="750" height="400">',
              "900" : '<img src="images/pixel_ratio_1/1000.gif" width="1000" height="1000">'
          },
          "1.5": {
              "300" : '<img src="images/pixel_ratio_2/400.gif" width="400" height="450">',
              "600" : '<img src="images/pixel_ratio_2/300.gif" width="300" height="300">',
              "800" : '<img src="images/pixel_ratio_2/750.gif" width="750" height="400">',
              "900" : '<img src="images/pixel_ratio_2/1000.gif" width="1000" height="1000">'
          }
      },
      breakpointsIn = [300,600,800,900],
      ratiosIn = [1,1.5],
      cacheKeyIn = JSON.stringify(imagesIn);
      
      // Device Pixel ratio
      imgQry.ratios = {};
      imgQry.ratio = 1;
      
      // Window width
      imgQry.width = 500;
      
    </script><script type="text/javascript">({write:function(a){"complete"!==document.readyState&&document.write(a)},closest:function(a,b){"use strict";for(var c=a.length,d=0;c>d&&!(a[d]>=b);)d+=1;return d=d===c?c-1:d},sort:function(a,b){"use strict";return b>a?-1:b>a?1:0},imgQry:function(a,b,c,d,e){"use strict";b=b.sort(this.sort),d=d.sort(this.sort),"undefined"==typeof a.imgQry&&(a.imgQry={}),"undefined"==typeof a.imgQry.images&&(a.imgQry.images={}),"undefined"==typeof a.imgQry.ratios&&(a.imgQry.ratios={}),"undefined"==typeof a.imgQry.breakpoints&&(a.imgQry.breakpoints={}),"undefined"==typeof a.imgQry.width&&(a.imgQry.width=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth||0),"undefined"==typeof a.imgQry.ratio&&(a.imgQry.ratio="undefined"!=typeof a.devicePixelRatio?a.devicePixelRatio:1),"undefined"==typeof a.imgQry.ratios[d]&&(a.imgQry.ratios[d]=d[this.closest(d,a.imgQry.ratio)]),"undefined"==typeof a.imgQry.breakpoints[b]&&(a.imgQry.breakpoints[b]=b[this.closest(b,a.imgQry.width)]),"undefined"==typeof a.imgQry.images[e]&&(a.imgQry.images[e]=c[a.imgQry.ratios[d]][a.imgQry.breakpoints[b]]),this.write(a.imgQry.images[e])}}).imgQry(this,breakpointsIn,imagesIn,ratiosIn,cacheKeyIn);</script>
    <script type="text/javascript">
      var initialImageSelection = imgQry.images[cacheKeyIn],
          expectedInitialImage = imagesIn["1"]["600"];
          
      test('Initial image selection', function() {
          equal(initialImageSelection, expectedInitialImage, 'Expected first image to be second image for pixel ratio 1');
      });
      
    </script>
    <script type="text/javascript">
      var initialCache = imgQry.images;
      
      test('Cache contains first result.', function() {
          var count = 0,
              image;
          for (image in initialCache) {
              if (initialCache.hasOwnProperty(image)) {
                  count += 1;
              }
          }
          equal(count, 1, 'Expecting global cache to contain first result');
      });
      
    </script>
    <script type="text/javascript">
      delete(imagesIn);
      delete(breakpointsIn);
      delete(ratiosIn)
      delete(cacheKeyIn);
      
      var initialImagasIn = typeof(imagesIn),
          initialBreakpointsIn = typeof(breakpointsIn),
          initialRatiosIn = typeof(ratiosIn),
          initialCacheKeyIn = typeof(cacheKeyIn);
          
      test('Arguments have been cleared', function() {
          equal(initialImagasIn, 'undefined', 'Expecting imagesIn to be undefined.');
          equal(initialBreakpointsIn, 'undefined', 'Expecting breakpointsIn to be undefined.');
          equal(initialRatiosIn, 'undefined', 'Expecting ratiosIn to be undefined.');
          equal(initialCacheKeyIn, 'undefined', 'Expecting cacheKeyIn to be undefined.');
      });
      
    </script>
    <script type="text/javascript">
      // breakpointsIn , imagesIn and ratiosIn are variables and not (as before) properties of the global object.
      var imagesIn = {
              "1":    {
                  "300" : '<img src="images/pixel_ratio_1/400.gif" width="400" height="450">',
                  "600" : '<img src="images/pixel_ratio_1/300.gif" width="300" height="300">',
                  "800" : '<img src="images/pixel_ratio_1/750.gif" width="750" height="400">',
                  "900" : '<img src="images/pixel_ratio_1/1000.gif" width="1000" height="1000">'
              },
              "1.5": {
                  "300" : '<img src="images/pixel_ratio_2/400.gif" width="400" height="450">',
                  "600" : '<img src="images/pixel_ratio_2/300.gif" width="300" height="300">',
                  "800" : '<img src="images/pixel_ratio_2/750.gif" width="750" height="400">',
                  "900" : '<img src="images/pixel_ratio_2/1000.gif" width="1000" height="1000">'
              }
      },
          breakpointsIn = [300,600,800,900],
          ratiosIn = [1,1.5],
          cacheKeyIn = JSON.stringify(imagesIn);
          
          // Device Pixel ratio
          imgQry.ratios = {};
          imgQry.ratio = 1;
          
      // Window width
      imgQry.width = 500;
      
    </script><script type="text/javascript">({write:function(a){"complete"!==document.readyState&&document.write(a)},closest:function(a,b){"use strict";for(var c=a.length,d=0;c>d&&!(a[d]>=b);)d+=1;return d=d===c?c-1:d},sort:function(a,b){"use strict";return b>a?-1:b>a?1:0},imgQry:function(a,b,c,d,e){"use strict";b=b.sort(this.sort),d=d.sort(this.sort),"undefined"==typeof a.imgQry&&(a.imgQry={}),"undefined"==typeof a.imgQry.images&&(a.imgQry.images={}),"undefined"==typeof a.imgQry.ratios&&(a.imgQry.ratios={}),"undefined"==typeof a.imgQry.breakpoints&&(a.imgQry.breakpoints={}),"undefined"==typeof a.imgQry.width&&(a.imgQry.width=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth||0),"undefined"==typeof a.imgQry.ratio&&(a.imgQry.ratio="undefined"!=typeof a.devicePixelRatio?a.devicePixelRatio:1),"undefined"==typeof a.imgQry.ratios[d]&&(a.imgQry.ratios[d]=d[this.closest(d,a.imgQry.ratio)]),"undefined"==typeof a.imgQry.breakpoints[b]&&(a.imgQry.breakpoints[b]=b[this.closest(b,a.imgQry.width)]),"undefined"==typeof a.imgQry.images[e]&&(a.imgQry.images[e]=c[a.imgQry.ratios[d]][a.imgQry.breakpoints[b]]),this.write(a.imgQry.images[e])}}).imgQry(this,breakpointsIn,imagesIn,ratiosIn,cacheKeyIn);</script>
    <script type="text/javascript">
      var secondImageSelection = imgQry.images[cacheKeyIn],
          expectedSecondImage = imagesIn["1"]["600"];
          
      test('Cached image selection', function() {
          equal(secondImageSelection, initialImageSelection, 'Expected second image to be the same as first');
          equal(secondImageSelection, expectedSecondImage, 'Expected second image to be second image for pixel ratio 1');
      });
      
    </script>
    <script type="text/javascript">
      var finalCache = imgQry.images;
      
      test('Cache contains one result', function() {
      
          var count = 0,
              image;
              
          for (image in finalCache) {
              if (imgQry.images.hasOwnProperty(image)) {
                  count += 1;
              }
          }
          
          equal(count, 1, 'Expected global cache to contain only one result');
      });
    </script>
  </body>
</html>